dsl_version: 0.5.0
service:
  name: designate-pool-manager
  containers:
    - name: designate-pool-manager
      image: designate-pool-manager
      pre:
        - name: designate-pool-manager-db-create
          dependencies:
            - {{ service.database }}
            - designate-main-db-create
          type: single
          command:
            mysql -u root -p{{ db.root_password }} -h {{ address(service.database) }} -e "create database {{ designate.db.name.pool_manager }};
            grant all privileges on {{ designate.db.name.pool_manager }}.* to '{{ designate.db.username }}'@'%' identified by '{{ designate.db.password }}'
            {% if percona.tls.enabled %} require ssl {% endif %};"
        - name: designate-pool-update
          dependencies:
            - designate-pool-manager-db-create
          files:
            - pools
            - designate-conf
          type: single
          command: designate-manage pool update --file /etc/designate/pools.yaml
        - name: designate-pool-sync
          dependencies:
            - designate-pool-update
          files:
            - designate-conf
          type: single
          command: designate-manage --config-file /etc/designate/designate.conf pool-manager-cache sync
      daemon:
        dependencies:
          - designate-api
        files:
          - designate-conf
        command: designate-pool-manager --config-file /etc/designate/designate.conf

files:
  designate-conf:
    path: /etc/designate/designate.conf
    content: designate.conf.j2
  pools:
    path: /etc/designate/pools.yaml
    content: pools.yaml.j2
