dsl_version: 0.5.0
service:
  name: designate-worker
  ports:
    - {{ designate.worker_port }}
  containers:
    - name: designate-worker
      image: designate-worker
      pre:
        - name: designate-pool-update
          # {% if designate.backend == "bind9" %}
          dependencies:
            - designate-backend-bind9
          # {% endif %}
          files:
            # {% if designate.backend == "bind9" %}
            - bind9-pools
            # {% else %}
            - fake-pools
            # {% endif %}
            - designate-conf
          type: single
          command: designate-manage pool update --file /etc/designate/pools.yaml
        # {% if designate.backend == "bind9" %}
        - name: rndc-reload
          dependencies:
            - designate-pool-update
          type: single
          command: rndc -s {{ address("designate-backend-bind9") }} -p {{ designate.rndc_port.cont }} reload
        # {% endif %}
      daemon:
        dependencies:
          - designate-api
        files:
          - designate-conf
          - rndc-conf
          - rndc-key
        command: designate-worker --config-file /etc/designate/designate.conf

files:
  designate-conf:
    path: /etc/designate/designate.conf
    content: designate.conf.j2
  fake-pools:
    path: /etc/designate/pools.yaml
    content: pools.yaml.j2
  bind9-pools:
    path: /etc/designate/pools.yaml
    content: bind9-pools.yaml.j2
  named-conf:
    path: /etc/bind/named.conf.options
    content: named.conf.options.j2
  rndc-conf:
    path: /etc/bind/rndc.conf
    content: rndc.conf.j2
  rndc-key:
    path: /etc/bind/rndc.key
    content: rndc.key.j2
